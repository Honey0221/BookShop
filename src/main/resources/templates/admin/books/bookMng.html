<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout2}">

<th:block layout:fragment="css">
  <link th:href="@{/css/admin/bookMng.css}" rel="stylesheet">
</th:block>

<th:block layout:fragment="script">
  <script type="module" th:src="@{/js/admin/bookMng/utils.js}"></script>
  <script type="module" th:src="@{/js/admin/bookMng/bookCategory.js}"></script>
  <script type="module" th:src="@{/js/admin/bookMng/bookForm.js}"></script>
  <script type="module" th:src="@{/js/admin/bookMng/bookList.js}"></script>
  <script type="module" th:src="@{/js/admin/bookMng/bookMng.js}"></script>
</th:block>

<div layout:fragment="content">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>상품 관리</h2>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#addBookModal">
          <i class="fas fa-plus me-1"></i>도서 추가
        </button>
        <button type="button" class="btn btn-success btn-sm"
                id="downloadExcelBtn">
          <i class="fas fa-file-excel me-1"></i>엑셀로 받기
        </button>
      </div>
    </div>

    <!-- 도서 추가 모달 -->
    <div class="modal fade" id="addBookModal" tabindex="-1"
         aria-labelledby="addBookModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addBookModalLabel">도서 추가</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close" id="closeModalBtn"></button>
          </div>
          <div class="modal-body">
            <form id="addBookForm">
              <div class="row mb-3">
                <div class="col-md-8">
                  <label for="title" class="form-label">제목 <span
                      class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="title"
                         name="title" required>
                </div>
                <div class="col-md-4">
                  <label for="price" class="form-label">가격 <span
                      class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="price"
                         name="price" required min="0">
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="author" class="form-label">저자 <span
                      class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="author"
                         name="author" required>
                </div>
                <div class="col-md-6">
                  <label for="publisher" class="form-label">출판사 <span
                      class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="publisher"
                         name="publisher" required>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-3">
                  <label for="mainCategory" class="form-label">대분류 <span
                      class="text-danger">*</span></label>
                  <select class="form-select" id="mainCategory" name="mainCategory">
                    <option value="">선택</option>
                    <option th:each="category : ${mainCategories}"
                            th:value="${category}"
                            th:text="${category}">
                    </option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="midCategory" class="form-label">중분류 <span
                      class="text-danger">*</span></label>
                  <select class="form-select" id="midCategory" name="midCategory">
                    <option value="">선택</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="subCategory" class="form-label">소분류 <span
                      class="text-danger">*</span></label>
                  <select class="form-select" id="subCategory" name="subCategory">
                    <option value="">선택</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="detailCategory" class="form-label">상세분류</label>
                  <select class="form-select" id="detailCategory" name="detailCategory">
                    <option value="">선택</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="stock" class="form-label">재고 <span
                      class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="stock"
                         name="stock" required min="0">
                </div>
              </div>

              <div class="mb-3">
                <label for="bookImage" class="form-label">이미지 <span
                    class="text-danger">*</span></label>
                <input type="file" class="form-control" id="bookImage"
                       name="bookImage" accept="image/*">
                <div id="imagePreview" class="mt-2" style="max-width: 200px;">
                  <!-- 이미지 미리보기 영역 -->
                </div>
              </div>

              <div class="mb-3">
                <label for="description" class="form-label">상세 설명</label>
                <textarea class="form-control" id="description"
                          name="description" rows="3"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">취소
            </button>
            <button type="button" class="btn btn-primary" id="saveBookBtn">
              저장
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex gap-2">
        <select id="statusFilter" class="form-select form-select-sm"
                style="width: auto;">
          <option value="">전체</option>
          <option value="SELL">판매중</option>
          <option value="SOLD_OUT">품절</option>
        </select>
        <select id="sortBy" class="form-select form-select-sm"
                style="width: auto;">
          <option value="id,desc">ID 내림차순</option>
          <option value="id,asc">ID 오름차순</option>
          <option value="stock,asc">재고 적은순</option>
          <option value="price,desc">가격 높은순</option>
          <option value="price,asc">가격 낮은순</option>
          <option value="createdAt,desc">최근 등록순</option>
          <option value="createdAt,asc">오래된 등록순</option>
        </select>
        <select id="pageSize" class="form-select form-select-sm"
                style="width: auto;">
          <option value="10">10개씩 보기</option>
          <option value="20">20개씩 보기</option>
          <option value="50">50개씩 보기</option>
        </select>
      </div>

      <div class="d-flex gap-2">
        <select id="searchType" class="form-select form-select-sm"
                style="width: auto;">
          <option value="title">제목</option>
          <option value="author">저자</option>
          <option value="publisher">출판사</option>
        </select>
        <div class="input-group input-group-sm" style="width: 300px;">
          <input type="text" class="form-control" id="searchKeyword"
                 placeholder="검색어 입력">
          <button class="btn btn-outline-secondary" type="button"
                  id="searchBtn">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark text-center">
        <tr>
          <th style="width: 5%">ID</th>
          <th style="width: 25%">제목</th>
          <th style="width: 15%">저자</th>
          <th style="width: 15%">출판사</th>
          <th style="width: 7%">재고</th>
          <th style="width: 10%">가격</th>
          <th style="width: 8%">상태</th>
          <th style="width: 10%">등록일</th>
          <th style="width: 5%"></th>
        </tr>
        </thead>
        <tbody class="text-center">
        <tr th:each="book : ${books}">
          <td class="small" th:text="${book.id}"></td>
          <td class="text-start" th:text="${book.title}"></td>
          <td class="small" th:text="${book.author}"></td>
          <td class="small" th:text="${book.publisher}"></td>
          <td class="small" th:text="${book.stock}"></td>
          <td class="small"
              th:text="${#numbers.formatInteger(book.price, 0, 'COMMA')}"></td>
          <td>
            <span th:class="${book.bookStatus.name() == 'SELL' ?
                  'badge bg-success' : 'badge bg-danger'}"
                  th:text="${book.bookStatus.name() == 'SELL' ? '판매중' : '품절'}"
                  style="font-size: 0.75rem;">
            </span>
          </td>
          <td class="small" th:text="${#temporals.format(book.createdAt,
                  'yyyy-MM-dd')}"></td>
          <td>
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-sm btn-primary edit-btn">
                <i class="fas fa-edit"></i>
              </button>
              <button type="button" class="btn btn-sm btn-danger delete-btn"
                      th:data-id="${book.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <nav th:if="${books.totalPages > 0}" aria-label="Page navigation"
         class="mt-3">
      <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${books.first} ? 'disabled'">
          <a class="page-link" th:href="@{/admin/bookMng(page=0)}">
            <i class="fas fa-angle-double-left"></i>
          </a>
        </li>

        <li class="page-item"
            th:classappend="${books.number < 10} ? 'disabled'">
          <a class="page-link"
             th:href="@{/admin/bookMng(page=${((books.number / 10) * 10) - 1})}">
            <i class="fas fa-angle-left"></i>
          </a>
        </li>

        <li class="page-item"
            th:each="page : ${#numbers.sequence(((books.number / 10) * 10),
             ((books.number / 10) * 10) + 9)}"
            th:if="${page < books.totalPages}"
            th:classappend="${page == books.number} ? 'active'">
          <a class="page-link" th:href="@{/admin/bookMng(page=${page})}"
             th:text="${page + 1}"></a>
        </li>

        <li class="page-item"
            th:classappend="${((books.number / 10) * 10) + 10 >= books.totalPages}
             ? 'disabled'">
          <a class="page-link"
             th:href="@{/admin/bookMng(page=${((books.number / 10) * 10) + 10})}">
            <i class="fas fa-angle-right"></i>
          </a>
        </li>

        <li class="page-item" th:classappend="${books.last} ? 'disabled'">
          <a class="page-link"
             th:href="@{/admin/bookMng(page=${books.totalPages - 1})}">
            <i class="fas fa-angle-double-right"></i>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>