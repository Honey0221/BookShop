<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/layout}">

<th:block layout:fragment="css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    .main-banner {
      width: 100%;
      height: 400px;
      margin-bottom: 50px;
    }

    .main-banner .swiper-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .category-swiper {
      width: 100%;
      height: auto;
      padding: 20px 40px;
    }

    .book-card {
      width: 100%;
      max-width: 200px;
      margin: 0 auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .book-card:hover {
      transform: translateY(-5px);
    }

    .book-image {
      width: 100%;
      height: 250px;
      object-fit: cover;
    }

    .book-info {
      padding: 1rem;
    }

    .book-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .book-price {
      color: #e44d26;
      font-weight: bold;
    }

    .swiper-button-next,
    .swiper-button-prev {
      color: #333;
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
      font-size: 20px;
    }

    .category-section {
      margin-bottom: 50px;
    }

    .category-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .main-categories {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .fixed-menu-item a,
    .main-category-header {
      padding: 10px 20px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
      color: #555;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .fixed-menu-item a:hover,
    .main-category-header:hover {
      background-color: #f8f9fa;
      border-color: #2196F3;
      color: #2196F3;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
    }

    .new-badge {
      background-color: #FF5722;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
    }

    .best-badge {
      background-color: #FFC107;
      color: #333;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
    }

    .category-divider {
      height: 24px;
      width: 1px;
      background-color: #e0e0e0;
      margin: 0 8px;
    }

    .mid-categories {
      position: absolute;
      top: calc(100% + 8px);
      left: 70%;
      transform: translateX(-50%);
      min-width: 300px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 12px;
      display: none;
      z-index: 1000;
    }

    .mid-categories::before {
      content: '';
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 20px;
      background: transparent;
    }

    .mid-categories-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      padding: 0;
      margin: 0;
      list-style: none;
      width: 100%;
    }

    .mid-category-item {
      width: 100%;
    }

    .mid-category-item a {
      display: block;
      padding: 10px 20px;
      color: #555;
      text-decoration: none;
      font-size: 13px;
      border-radius: 6px;
      transition: all 0.2s ease;
      white-space: nowrap;
      width: 100%;
    }

    .mid-category-item a:hover {
      background-color: #f8f9fa;
      color: #2196F3;
    }

    .category-item {
      position: relative;
    }

    .category-item::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      right: 0;
      height: 8px;
      background: transparent;
    }

    .category-item:hover .mid-categories {
      display: block;
    }

    /* 반응형 디자인 */
    @media (max-width: 768px) {
      .main-categories {
        gap: 8px;
      }

      .fixed-menu-item a,
      .main-category-header {
        padding: 8px 16px;
        font-size: 13px;
      }

      .mid-categories {
        min-width: 280px;
        left: 0;
        transform: none;
      }
    }

    .new-section,
    .best-section {
      max-width: 1200px;
      margin: 50px auto;
      padding: 0;
      overflow: hidden;
    }

    .section-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      font-size: 20px;
      color: #e44d26;
    }

    .swiper-container {
      width: 100%;
      padding: 20px 0;
      position: relative;
      overflow: visible;
    }

    .swiper-wrapper {
      align-items: center;
    }

    .swiper-slide {
      width: 200px;
      opacity: 0.5;
      transition: all 0.3s ease;
      transform: scale(0.8);
    }

    .swiper-slide-active {
      opacity: 1;
      transform: scale(1);
    }

    .swiper-slide-next,
    .swiper-slide-prev {
      opacity: 0.7;
      transform: scale(0.9);
    }

    .swiper-button-next,
    .swiper-button-prev {
      color: #333;
      background: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .swiper-button-next {
      right: 0;
    }

    .swiper-button-prev {
      left: 0;
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
      font-size: 18px;
    }

    .book-card {
      margin: 0 auto;
      transition: all 0.3s ease;
    }

    .book-image {
      width: 100%;
      height: 280px;
      object-fit: cover;
    }

    .book-info {
      padding: 15px;
    }

    .book-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .book-price {
      color: #e44d26;
      font-weight: bold;
      font-size: 16px;
    }

    .swiper-pagination {
      bottom: -5px;
    }

    .swiper-pagination-bullet {
      background: #333;
    }

    /* 최근 본 상품 사이드바 스타일 */
    .recent-products-sidebar {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 160px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .recent-products-title {
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }

    .recent-products-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
    }

    .recent-product-item {
      position: relative;
      width: 120px;
      height: 160px;
      margin: 0 auto;
    }

    .recent-product-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .recent-product-item:hover .recent-product-info {
      display: block;
    }

    .recent-product-info {
      display: none;
      position: absolute;
      left: -240px;
      top: 50%;
      transform: translateY(-50%);
      width: 220px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1001;
    }

    .recent-product-info::after {
      content: '';
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 10px 0 10px 10px;
      border-style: solid;
      border-color: transparent transparent transparent white;
    }

    .recent-product-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .recent-product-price {
      font-size: 13px;
      color: #e44d26;
    }

    /* 스크롤바 스타일링 */
    .recent-products-list::-webkit-scrollbar {
      width: 4px;
    }

    .recent-products-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }

    .recent-products-list::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 2px;
    }

    .recent-products-list::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .recent-product-item {
      text-decoration: none;
      color: inherit;
      display: block;
    }

    /* 반응형 디자인 */
    @media (max-width: 1400px) {
      .recent-products-sidebar {
        display: none;
      }
    }
  </style>
</th:block>

<div layout:fragment="content">
  <div class="category-container">
    <ul class="main-categories">
      <li class="fixed-menu-item">
        <a href="/book-list/best">
          베스트
          <span class="best-badge">BEST</span>
        </a>
      </li>
      <li class="fixed-menu-item">
        <a href="/book-list/new">
          신상품
          <span class="new-badge">NEW</span>
        </a>
      </li>
      <li class="fixed-menu-item">
        <a href="/notices">
          공지사항
        </a>
      </li>

      <li style="border-left: 1px solid #e0e0e0; margin: 0 10px;"></li>

      <li class="category-item" th:each="mainCat : ${mainCategories}">
        <div class="main-category-header" th:data-category="${mainCat}">
          <span th:text="${mainCat}">메인카테고리</span>
        </div>
        <div class="mid-categories" th:id="'mid-' + ${#strings.replace(mainCat, ' ', '-')}">
          <ul class="mid-categories-list">
            <!-- 중간 카테고리가 여기에 로드됨 -->
          </ul>
        </div>
      </li>
    </ul>
  </div>

  <div class="best-section">
    <h2 class="section-title">
      <i class="fas fa-crown"></i>
      베스트상품
    </h2>
    <div class="swiper-container best-swiper">
      <div class="swiper-wrapper">
        <div class="swiper-slide" th:each="book : ${bestBooks}">
          <div class="book-card" th:data-book-id="${book.id}">
            <img th:src="${book.imageUrl}" th:alt="${book.title}" class="book-image">
            <div class="book-info">
              <h3 class="book-title" th:text="${book.title}">도서 제목</h3>
              <div class="book-price" th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')} + '원'">
                가격
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>

  <div class="new-section">
    <h2 class="section-title">
      <i class="fas fa-star"></i>
      신상품
    </h2>
    <div class="swiper-container new-swiper">
      <div class="swiper-wrapper">
        <div class="swiper-slide" th:each="book : ${newBooks}">
          <div class="book-card" th:data-book-id="${book.id}">
            <img th:src="${book.imageUrl}" th:alt="${book.title}" class="book-image">
            <div class="book-info">
              <h3 class="book-title" th:text="${book.title}">도서 제목</h3>
              <div class="book-price" th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')} + '원'">
                가격
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
  <!-- 개인화 추천 섹션 -->
  <section class="recommended-section" th:if="${#authorization.expression('isAuthenticated()')}">
    <div class="category-container">
      <h2 class="section-title">
        <i class="fas fa-magic"></i>
        맞춤 추천
        <span class="new-badge">AI</span>
      </h2>
      <div class="swiper personalized-swiper">
        <div class="swiper-wrapper">
          <div class="swiper-slide" th:each="book : ${personalizedBooks}">
            <div class="book-card" th:data-book-id="${book.bookId}">
              <img class="book-image" th:src="${book.imageUrl}" th:alt="${book.title}">
              <div class="book-info">
                <h3 class="book-title" th:text="${book.title}">책 제목</h3>
                <p class="book-price" th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')} + '원'">
                  가격
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <!-- 협업 필터링 추천 섹션 -->
  <section class="recommended-section" th:if="${#authorization.expression('isAuthenticated()')}">
    <div class="category-container">
      <h2 class="section-title">
        <i class="fas fa-users"></i>
        비슷한 취향의 회원들이 선택한 책
        <span class="best-badge">PICK</span>
      </h2>
      <div class="swiper collaborative-swiper">
        <div class="swiper-wrapper">
          <div class="swiper-slide" th:each="book : ${collaborativeBooks}">
            <div class="book-card" th:data-book-id="${book.bookId}">
              <img class="book-image" th:src="${book.imageUrl}" th:alt="${book.title}">
              <div class="book-info">
                <h3 class="book-title" th:text="${book.title}">책 제목</h3>
                <p class="book-price" th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')} + '원'">
                  가격
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <!-- 카테고리 기반 추천 섹션 -->
  <section class="recommended-section" th:if="${#authorization.expression('isAuthenticated()')}">
    <div class="category-container">
      <h2 class="section-title">
        <i class="fas fa-bookmark"></i>
        관심 카테고리의 새로운 책
        <span class="new-badge">NEW</span>
      </h2>
      <div class="swiper content-based-swiper">
        <div class="swiper-wrapper">
          <div class="swiper-slide" th:each="book : ${contentBasedBooks}">
            <div class="book-card" th:data-book-id="${book.bookId}">
              <img class="book-image" th:src="${book.imageUrl}" th:alt="${book.title}">
              <div class="book-info">
                <h3 class="book-title" th:text="${book.title}">책 제목</h3>
                <p class="book-price" th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')} + '원'">
                  가격
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>

    <!-- 최근 본 상품 사이드바 -->
    <div class="recent-products-sidebar" th:if="${#authorization.expression('isAuthenticated()')}">
      <div class="recent-products-title">최근 본 상품</div>
      <div class="recent-products-list">
        <a th:href="@{/item(bookId=${book.id})}" class="recent-product-item" th:each="book : ${recentViewedBooks}">
          <img th:src="${book.imageUrl}" th:alt="${book.title}" class="recent-product-image">
          <div class="recent-product-info">
            <div class="recent-product-title" th:text="${book.title}">책 제목</div>
            <div class="recent-product-price"
              th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')} + '원'">
              가격
            </div>
          </div>
        </a>
      </div>
    </div>
</div>

<th:block layout:fragment="script">
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
      // 중간 카테고리 로드 함수
      const loadMidCategories = function () {
        const mainCategories = document.querySelectorAll('.main-category-header');
        mainCategories.forEach(mainCategoryElement => {
          const mainCategory = mainCategoryElement.getAttribute('data-category');
          const midCategoriesContainer = mainCategoryElement.nextElementSibling;
          const midCategoriesList = midCategoriesContainer.querySelector('.mid-categories-list');

          fetch(`/api/categories/${encodeURIComponent(mainCategory)}/mid`)
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(midCategories => {
              const midCategoriesHtml = midCategories.map(midCat => `
                <li class="mid-category-item">
                  <a href="/book-list/category?main=${encodeURIComponent(mainCategory)}&mid=${encodeURIComponent(midCat)}">
                    ${midCat}
                  </a>
                </li>
              `).join('');

              midCategoriesList.innerHTML = midCategoriesHtml;
            })
            .catch(error => {
              console.error('Error loading mid categories:', error);
            });
        });
      };

      // 페이지 로드 시 중간 카테고리 로드
      loadMidCategories();

      // Swiper 설정 (기존 코드 유지)
      const swiperConfig = {
        slidesPerView: 5,
        centeredSlides: true,
        loop: true,
        spaceBetween: 30,
        speed: 400,
        pagination: {
          el: '.swiper-pagination',
          clickable: true,
        },
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
        autoplay: {
          delay: 1000,
          disableOnInteraction: false,
          pauseOnMouseEnter: false,
          enabled: false
        },
        effect: 'coverflow',
        coverflowEffect: {
          rotate: 0,
          stretch: 0,
          depth: 100,
          modifier: 1,
          slideShadows: false,
        },
        breakpoints: {
          320: {
            slidesPerView: 1,
          },
          640: {
            slidesPerView: 2,
          },
          768: {
            slidesPerView: 3,
          },
          1024: {
            slidesPerView: 5,
          },
        },
        on: {
          click: function (swiper, event) {
            // 클릭된 슬라이드의 book-card를 찾아서 처리
            const clickedSlide = swiper.clickedSlide;
            if (clickedSlide) {
              const bookCard = clickedSlide.querySelector('.book-card');
              if (bookCard) {
                // 클릭한 상품의 상세 페이지로 이동
                const bookId = bookCard.dataset.bookId; // data-book-id 속성 필요
                window.location.href = `/item?bookId=${bookId}`;
              }
            }
          }
        }
      };

      // 기존 Swiper 초기화
      const newSwiper = new Swiper('.new-swiper', swiperConfig);
      const bestSwiper = new Swiper('.best-swiper', swiperConfig);

      // 새로운 추천 섹션 Swiper 초기화
      const personalizedSwiper = new Swiper('.personalized-swiper', swiperConfig);
      const collaborativeSwiper = new Swiper('.collaborative-swiper', swiperConfig);
      const contentBasedSwiper = new Swiper('.content-based-swiper', swiperConfig);

      // 기존 hover 이벤트
      const newContainer = document.querySelector('.new-swiper');
      newContainer.addEventListener('mouseenter', function () {
        newSwiper.autoplay.start();
      });
      newContainer.addEventListener('mouseleave', function () {
        newSwiper.autoplay.stop();
      });
      const bestContainer = document.querySelector('.best-swiper');
      bestContainer.addEventListener('mouseenter', function () {
        bestSwiper.autoplay.start();
      });
      bestContainer.addEventListener('mouseleave', function () {
        bestSwiper.autoplay.stop();
      });
      const personalizedContainer = document.querySelector('.personalized-swiper');
      personalizedContainer.addEventListener('mouseenter', function () {
        personalizedSwiper.autoplay.start();
      });
      personalizedContainer.addEventListener('mouseleave', function () {
        personalizedSwiper.autoplay.stop();
      });
      const collaborativeContainer = document.querySelector('.collaborative-swiper');
      collaborativeContainer.addEventListener('mouseenter', function () {
        collaborativeSwiper.autoplay.start();
      });
      collaborativeContainer.addEventListener('mouseleave', function () {
        collaborativeSwiper.autoplay.stop();
      });
      const contentBasedContainer = document.querySelector('.content-based-swiper');
      contentBasedContainer.addEventListener('mouseenter', function () {
        contentBasedSwiper.autoplay.start();
      });
      contentBasedContainer.addEventListener('mouseleave', function () {
        contentBasedSwiper.autoplay.stop();
      });
    });
    /*]]>*/
  </script>
</th:block>

</html>